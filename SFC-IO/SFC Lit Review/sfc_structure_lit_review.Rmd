---
title: "Determining SFC Model Structure Based on Lit Review"
author: "Travis Dorsey"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)

library(knitr)
library(tidyverse)
library(kableExtra)

### Define Structure

# Sectors 
sectors_basic <- c("Households", "NFCs", "FCs", "Government", "RoW", "Total")
sectors_prod_basic <- c("Production", sectors_basic)

sectors_adv <- c("Households", "NFCs", "MFIs", "NMFIs", "Central Bank", "Government", "RoW", "Total")
sectors_prod_adv <- c("Production", sectors_adv)

# Transaction Flows
transflows_basic <- c("Consumption", "Gross capital formation", "Exports", "Imports", "Taxes-subsidies",
                      "Wages", "GOS & mixed income")

transflows_adv <- c("Consumption", "Government wages (to Production)", "Other government consumption", 
                    "Gross capital formation", "Exports", "Imports", "Taxes-subsidies",             
                    "Private Wages", "Government wages (to Households)", "GOS & mixed income")

transflows_totals <- c("Total: net lending (1)", "Residual transaction (2)", 
                       "Actual net lending (3) = (1) + (2)")

transflows_propinc <- c("Interest", "Interest paid by FCs", "Interest paid to FCs", "Dividends")

transflows_secondinc <- c("Income taxes", "Social contributions", "Social benefits")

transflows_other <- c("Other Investment Income", "Household's social contributions supplements",
                      "Pension adjustment")

# Balance Sheet
assets_hilevel <- c("Monetary gold and special drawing rights", "Currency and deposits",
                    "Debt securities", "Loans", "Equity and investment fund shares/units",
                    "Insurance, pensions, and standardized guarantee schemes",
                    "Financial derivatives and employee stock options", "Other accounts receivable")

assets_agg <- c("Interest-bearing financial stocks (F.2 + F.3 + F.4)",
                "Equity (F.5)",
                "Insurance and Pensions (F.6)",
                "Other Financial Stocks (F.1 + F.7 + F.8)")

assets_capstock <- c("Housing capital stock", "NFCs capital stock", "Government capital stock")

assets_totalreal <- c("Total: real assets")

assets_int <- c("Interest-bearing assets", "Interest-bearing liabilities")
assets_equity <- c("Equity - assets", "Equity - liabilities")
assets_pension <- c("Pensions")

assets_total <- c("Total: financial net worth (1)", "Residual financial instrument (2)",
                  "Actual financial net worth (3) = (1) + (2)")

# Stock-Flows
stock_flow_opening_nw <- "Opening Net Worth (prior year) (1)"

stock_flow_realassets <- c("Gross Capital Formation (2)",
                           "Depreciation of real assets (3)",
                           "Other changes in real assets (4)")

stock_flow_total_ra <- "Changes in Real Assets (5) = (2)-(3)+(4)"

stock_flow_changes_net_fa <- c(assets_int, assets_equity, assets_pension, "Residual FI")
title_stock_flow_changes_net_fa <- "Changes in net financial\n assets arising from\n financial transactions"

stock_flow_actual_nl <- "Actual net lending (6)"

stock_flow_changes_other <- stock_flow_changes_net_fa
title_stock_flow_changes_other <- "Other changes in\n net financial assets"

stock_flow_total_other_changes <- "Total other changes in net financial assets (7)"

stock_flow_total_change_netfa <- "Change in Net Financial Assets (8) = (6) + (7)"
stock_flow_closing_nw <- "Closing Net Worth (current year) (9) = (1) + (5) + (8)"

```

# SFC Literature Review Highlights

Development of the empirical SFC model based on the process laid out in:

-   George, Pratas, and Dafermos (2025): Deriving the accounting
    structure of country-specific SFC models: a step-by-step approach

## Key Features

### Transactions Flow Matrix

Starting from the national accounts, George, et al. (2025) make the
following adjustments:  

- Separate production into its own sector (prevents over complication of the model)  
- Remove insignificant flows (those \< 1% of GDP)  
- Include property income flows (e.g., interest, dividends, etc.)  
- Include secondary income flows (e.g., income tax, social contributions and benefits, etc.)  
- Include capital account flows (e.g., pension adjustments, capital taxes, etc.)  
- Remove adjustments related to FISIM (based on discredited Loanable Funds Theory)  
- Breakdown Government consumption (i.e., treat govt wages and procurement separately from services provided like public education)  
- Remove imputed rents (not actual monetary flows)  
- Address statistical discrepancy between financial and non-financial accounts  

After these adjustments, the authors arrive at the following structure
for the transaction flow matrix:

```{r paper_tfm}
paper_tfm <- tibble(Flows = c(transflows_adv, transflows_propinc, transflows_secondinc, transflows_other,
               transflows_totals))

tfm_other_break <- nrow(paper_tfm)-length(transflows_totals) - length(transflows_other)
tfm_total_break <- nrow(paper_tfm)-length(transflows_totals)

paper_tfm %>%
  kbl() %>%
  kable_classic("hover", full_width = F) %>%
  row_spec(tfm_other_break, extra_css = "border-bottom: 1px dashed") %>%
  row_spec(tfm_total_break, extra_css = "border-bottom: 1px solid") %>%
  row_spec(0, bold = T)
```

### Balance Sheet Matrix

George, et al. (2025) identify the following table of High Level
Financial Stocks in National Accounts required to develop the balance
sheet matrix.

```{r highlevel_assets}
highlevel_assets_tbl <- tibble(Description = assets_hilevel) %>%
  mutate(Code = paste0("F.", row_number())) %>%
  select(Code, Description)

highlevel_assets_tbl %>%
  kbl() %>%
  kable_classic("hover", full_width = F) %>%
  column_spec (1, border_right = T) %>%
  row_spec(0, bold = T)
```

In order to establish a direct correspondence with the interest flows in
the transaction flow matrix, the authors define an aggregated set of
financial stocks:

```{r agg_assets}
tibble(Description = assets_agg) %>%
  kbl() %>%
  kable_classic("hover", full_width = F) %>%
  row_spec(0, bold = T)
```

Which, after including capital stocks from the Household, Government,
and NFC sectors, results in a final balance sheet matrix with the
following structure:

```{r final_balance_sheet}
final_balance_sheet_tbl <- tibble(`Financial Stock` = c(assets_capstock, assets_totalreal, assets_int, assets_equity, 
                                                        assets_pension, assets_total))

bs_breaks <- tibble(section_len = c(length(assets_capstock), length(assets_totalreal), length(assets_int), length(assets_equity),
                                    length(assets_pension), length(assets_total))) %>%
  mutate(breaks = cumsum(section_len))

final_balance_sheet_tbl %>%
  kbl() %>%
  kable_classic("hover", full_width = F) %>%
  row_spec(bs_breaks$breaks, extra_css = "border-bottom: 1px solid") %>%
  row_spec(0, bold = T)

```

Given the prevalence of insurance in Taiwan as a financial instrument,
including this as a balance sheet item with pensions makes sense.


### Stock-Flow Matrix

Depicts the change in net worth of each sector and links the Transaction Flow Matrix with the Balance Sheet Matrix.

```{r sfm}
sfm_top <- tibble(stock_flows = c(stock_flow_opening_nw, stock_flow_realassets, stock_flow_total_ra))

sfm_changes_fin_trans <- tibble(stock_flows = stock_flow_changes_net_fa)

sfm_mid <- tibble(stock_flows = stock_flow_actual_nl)

sfm_changes_other <- tibble(stock_flows = stock_flow_changes_other)

sfm_bot <- tibble(stock_flows = c(stock_flow_total_other_changes, stock_flow_total_change_netfa, stock_flow_closing_nw))


sfm_tbl <- bind_rows(sfm_top, sfm_changes_fin_trans, sfm_mid, sfm_changes_other, sfm_bot) 

sfm_breaks <- tibble(section_len = c(length(stock_flow_opening_nw), length(stock_flow_realassets), length(stock_flow_total_ra),
                                     length(stock_flow_changes_net_fa), length(stock_flow_actual_nl), length(stock_flow_changes_other),
                                     length(stock_flow_total_other_changes), length(stock_flow_total_change_netfa), 
                                     length(stock_flow_closing_nw))) %>%
  mutate(breaks = cumsum(section_len))

pack1 <- tibble(startrow = nrow(sfm_top)+1,
                endrow = nrow(sfm_top)+nrow(sfm_changes_fin_trans))

pack2 <- tibble(startrow = pack1$endrow + nrow(sfm_mid) + 1,
                endrow = pack1$endrow + nrow(sfm_mid) + nrow(sfm_changes_other))

sfm_tbl %>%
  kbl(col.names = "Real and Financial Asset Stock Flows") %>%
  kable_classic("hover", full_width = F) %>%
  row_spec(c(0, 1, nrow(sfm_top), nrow(sfm_tbl)-1, nrow(sfm_tbl)), bold = T) %>%
  pack_rows(title_stock_flow_changes_net_fa, bold = F, start_row = pack1$startrow, end_row = pack1$endrow) %>%
  pack_rows(title_stock_flow_changes_net_fa, bold = F, start_row = pack2$startrow, end_row = pack2$endrow) %>%
  row_spec(sfm_breaks$breaks, extra_css = "border-bottom: 1px solid")
```



