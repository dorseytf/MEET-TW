---
title: "Taiwan SFC Data Availability"
author: "Travis Dorsey"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

#############
# Libraries #
#############

library(tidyverse)
library(httr)
library(jsonlite)
library(xml2)
library(here)
library(janitor)


###############
# Definitions #
###############

### API Base URLs
cbc_api_base <- "https://cpx.cbc.gov.tw/API/DataAPI/Get?FileName="

dgbas_api_base <- "https://nstatdb.dgbas.gov.tw/dgbasall/webMain.aspx?sdmx"

#############
# Functions #
#############

### CBC API Call Function
source(here("Functions", "get_cbc_data.R"))

### DGBAS API Call Function
source(here("Functions", "get_dgbas_api_data.R"))

```


```{r cbc_data_calls}
### Which series to retrieve from the CBC via API
cbc_pull_list <- c("EF11Y01en", # Reserve Money (Avg of Daily Figures) Annual
                   "EF15Y01en", # Monetary Aggregates (Avg of Daily Figures) Annual
                   "EFA4Y01en", # Loans & Investments (measured at original cost) Annual
                   "BP01Y01en", # NTD-USD Exchange Rates Annual
                   "EF05Y01en", # Financial Markets
                   "EG23Y01en", # Transactions, Issues, Redemptions and Amounts Outstanding of Government Bonds Annual
                   "EGB4Y01en", # Transactions, Issues, Redemptions and Amounts Outstanding of Corporate Bonds and Bank Debentures Annual
                   "EF39Y01en", # Consolidated Assets of Financial Institutions Annual
                   "EF41Y01en", # Consolidated Liabilities of Financial Institutions Annual
                   "EF35Y01en", # Consolidated Assets of Monetary Institutions Annual
                   "EF37Y01en", # Consolidated Liabilities of Monetary Institutions Annual
                   "EF23Y01en", # Consolidated Assets of Central Bank Annual
                   "EF25Y01en", # Consolidated Liabilities of Central Bank Annual
                   "EF27Y01en", # Consolidated Assets of Other Monetary Banks Annual
                   "EF29Y01en", # Consolidated Liabilities of Other Monetary Banks Annual
                   "EI79Y01en", # Deposits with All Banks by Sector Annual
                   "EI86Y01en", # Loans and Discounts at All Banks by Sector Annual
                   "EG27Y01en", # Transactions of Listed Stock and Stock Price Index Annual
                   "EG2AY01en", # Central Bank Rates Annual
                   "EG2BY01en", # Rates by five major banks Annual
                   "EG39Y01en", # Weighted Average Interest Rates on Deposits and Loans Annual
                   "EH45Y01en", # New Loans and Interest Rates by Five Leading Banks Annual
                   "EG43Y01en", # Capital Market Interest Rates Annual
                   "EG75Y01en", # Loans & Investments Revalued - Monetary Financial Institutions Annual
                   "BPF4Y01en", # International Investment Position Annual
                   "BPP2Y01en", # Balance of Payments Annual
                   "FL01_en",   # Financial Transactions Annual
                   "FL02_en"    # Financial Assets and Liabilities Annual
                   )

cbc_database_codes <- read_csv("CBC Database Codes.csv", locale = ) %>%
  clean_names() %>%
  fill(category, .direction = "down") %>%
  filter(item_code %in% cbc_pull_list) %>%
  mutate(data_element = iconv(data_element, from = "UTF-8", to = "ASCII", sub = "-"),
         api_call = sprintf("%s/%s", cbc_api_base, item_code))

n_cbc_series <- length(cbc_pull_list)

# Create list to store the datasets
cbc_data_series <- vector("list", length = n_cbc_series)

# Pull via API and convert JSON to a dataframe
for(c in 1:n_cbc_series){
  print(c)
  
  cbc_data_series[[c]] <- get_cbc_data(cbc_database_codes$api_call[c])
}
names(cbc_data_series) <- cbc_database_codes$data_element

cbc_data_series <- bind_rows(cbc_data_series, .id = "data_element")
```


```{r dgbas_api_calls}

dgbas_api_list <- read_csv(here("SFC-IO", "SFC Data Availability", "DGBAS API Database Codes.csv"),
                           locale = locale(encoding = "Big5")) %>%
  mutate(api_call = sprintf("%s/%s/%s&%s", dgbas_api_base, data_series_id, data_dimension, data_period))

n_dgbas_series <- nrow(dgbas_api_list)
dgbas_macro_data <- vector("list", length = n_dgbas_series)

for(d in 1:n_dgbas_series){
  dgbas_macro_data[[d]] <- get_dgbas_api_data(dgbas_api_list$api_call[d])
}
names(dgbas_macro_data) <- dgbas_api_list$data_item_en

dgbas_macro_data <- bind_rows(dgbas_macro_data, .id = "data_item")

```












